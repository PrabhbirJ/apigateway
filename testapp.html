<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Gateway Demo - Package Showcase</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .demo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .auth-section {
            grid-column: 1 / -1;
        }
        
        .feature-demo {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .logs-section {
            grid-column: 1 / -1;
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .btn {
            background: #4F46E5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #3730A3;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            background: #9CA3AF;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-danger {
            background: #EF4444;
        }
        
        .btn-danger:hover {
            background: #DC2626;
        }
        
        .btn-success {
            background: #10B981;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .input-group {
            margin: 10px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }
        
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success {
            background: #10B981;
        }
        
        .status-error {
            background: #EF4444;
        }
        
        .status-warning {
            background: #F59E0B;
        }
        
        .response-display {
            background: #F3F4F6;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .rate-limit-bar {
            width: 100%;
            height: 6px;
            background: #E5E7EB;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .rate-limit-fill {
            height: 100%;
            background: linear-gradient(90deg, #10B981 0%, #F59E0B 70%, #EF4444 100%);
            transition: width 0.3s ease;
        }
        
        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .feature-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .demo-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        @media (max-width: 768px) {
            .demo-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        const API_BASE = 'http://127.0.0.1:5001';

        function APIGatewayDemo() {
            // Auth state
            const [token, setToken] = useState(localStorage.getItem('demo_token'));
            const [user, setUser] = useState(null);
            const [loginForm, setLoginForm] = useState({ username: 'testuser' });
            
            // Demo state
            const [logs, setLogs] = useState([]);
            const [rateLimitStatus, setRateLimitStatus] = useState({});
            const [lastResponse, setLastResponse] = useState(null);
            const [loading, setLoading] = useState(false);
            
            // Form states
            const [contactForm, setContactForm] = useState({
                name: 'John Doe',
                email: 'john@example.com',
                message: 'Testing contact form with rate limiting!'
            });
            
            const [postForm, setPostForm] = useState({
                title: 'My Test Post',
                content: 'This is a test post to demonstrate the full decorator stack!',
                tags: 'demo,test,logging'
            });
            
            const [userForm, setUserForm] = useState({
                username: 'newuser',
                age: 25,
                email: 'newuser@company.com'
            });

            const [profileForm, setProfileForm] = useState({
                username: 'john123',
                email: 'john.doe@company.com',
                age: 28,
                department: 'Engineering'
            });

            // Add log entry
            const addLog = useCallback((level, message, data = {}) => {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    level,
                    message,
                    data,
                    id: Date.now() + Math.random()
                };
                setLogs(prev => [logEntry, ...prev].slice(0, 50)); // Keep last 50 logs
            }, []);

            // API call wrapper
            const apiCall = async (endpoint, options = {}) => {
                setLoading(true);
                addLog('INFO', `Making API call to ${endpoint}`, { method: options.method || 'GET' });
                
                try {
                    const headers = {
                        'Content-Type': 'application/json',
                        ...options.headers
                    };
                    
                    if (token && !endpoint.includes('/get-token')) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }

                    const response = await fetch(`${API_BASE}${endpoint}`, {
                        ...options,
                        headers
                    });

                    const data = await response.json();
                    
                    // Update rate limit status from headers
                    if (response.headers.get('X-RateLimit-Remaining')) {
                        setRateLimitStatus(prev => ({
                            ...prev,
                            [endpoint]: {
                                remaining: parseInt(response.headers.get('X-RateLimit-Remaining')),
                                limit: parseInt(response.headers.get('X-RateLimit-Limit')),
                                reset: response.headers.get('X-RateLimit-Reset')
                            }
                        }));
                    }

                    if (response.ok) {
                        addLog('SUCCESS', `API call successful: ${response.status}`, { endpoint, response: data });
                        setLastResponse({ status: response.status, data, endpoint });
                        return data;
                    } else {
                        addLog('ERROR', `API call failed: ${response.status}`, { endpoint, error: data });
                        setLastResponse({ status: response.status, data, endpoint, error: true });
                        return null;
                    }
                } catch (error) {
                    addLog('ERROR', `Network error: ${error.message}`, { endpoint });
                    setLastResponse({ error: true, message: error.message, endpoint });
                    return null;
                } finally {
                    setLoading(false);
                }
            };

            // Auth functions
            const login = async () => {
                const data = await apiCall('/get-token', {
                    method: 'POST',
                    body: JSON.stringify(loginForm)
                });
                
                if (data?.access_token) {
                    setToken(data.access_token);
                    localStorage.setItem('demo_token', data.access_token);
                    addLog('SUCCESS', 'Login successful', { username: loginForm.username });
                }
            };

            const logout = () => {
                setToken(null);
                setUser(null);
                localStorage.removeItem('demo_token');
                addLog('INFO', 'Logged out');
            };

            const getCurrentUser = async () => {
                const data = await apiCall('/whoami');
                if (data?.user) {
                    setUser(data.user);
                    addLog('SUCCESS', 'User info retrieved', { user: data.user });
                }
            };

            // Demo functions
            const testContactForm = async () => {
                await apiCall('/contact', {
                    method: 'POST',
                    body: JSON.stringify(contactForm)
                });
            };

            const testRateLimit = async () => {
                addLog('INFO', 'Starting rate limit test (10 rapid requests)');
                for (let i = 1; i <= 10; i++) {
                    await new Promise(resolve => setTimeout(resolve, 100)); // Small delay
                    await apiCall('/contact', {
                        method: 'POST',
                        body: JSON.stringify({
                            ...contactForm,
                            message: `Rate limit test #${i}`
                        })
                    });
                }
            };

            const createPost = async () => {
                const postData = {
                    ...postForm,
                    tags: postForm.tags.split(',').map(tag => tag.trim())
                };
                await apiCall('/posts', {
                    method: 'POST',
                    body: JSON.stringify(postData)
                });
            };

            const createUser = async () => {
                await apiCall('/admin/users', {
                    method: 'POST',
                    body: JSON.stringify(userForm)
                });
            };

            const getAdminStats = async () => {
                await apiCall('/admin/stats');
            };

            const getPremiumData = async () => {
                await apiCall('/premium/data');
            };

            const testValidationError = async () => {
                await apiCall('/posts', {
                    method: 'POST',
                    body: JSON.stringify({
                        title: 'Test',
                        invalid_field: 'This should cause validation error'
                    })
                });
            };

            const testProfileValidation = async () => {
                await apiCall('/profile-demo', {
                    method: 'POST',
                    body: JSON.stringify(profileForm)
                });
            };

            const testInvalidProfile = async () => {
                await apiCall('/profile-demo', {
                    method: 'POST',
                    body: JSON.stringify({
                        username: 'xy',  // Too short
                        email: 'bad@gmail.com',  // Wrong domain
                        age: 16,  // Too young
                        department: 'InvalidDept',  // Not allowed
                        extra_field: 'forbidden'  // Extra field
                    })
                });
            };

            const getProfileExamples = async () => {
                await apiCall('/profile-demo/examples');
            };

            // Get custom role token
            const getCustomToken = async (role) => {
                const data = await apiCall(`/get-custom-token/${role}`);
                if (data?.access_token) {
                    setToken(data.access_token);
                    localStorage.setItem('demo_token', data.access_token);
                    addLog('SUCCESS', `Got ${role} token`, { role });
                }
            };

            // Auto-get user info if token exists
            useEffect(() => {
                if (token && !user) {
                    getCurrentUser();
                }
            }, [token]);

            return (
                <div className="container">
                    <div className="header">
                        <h1>🚀 API Gateway Package Demo</h1>
                        <p>Interactive demonstration of validation, authorization, rate limiting & logging</p>
                    </div>

                    {/* Authentication Section */}
                    <div className="card auth-section">
                        <h2>🔐 Authentication & Authorization</h2>
                        
                        {!token ? (
                            <div>
                                <div className="input-group">
                                    <label>Username</label>
                                    <select 
                                        value={loginForm.username}
                                        onChange={(e) => setLoginForm({...loginForm, username: e.target.value})}
                                    >
                                        <option value="testuser">testuser (user, admin)</option>
                                        <option value="user1">user1 (user)</option>
                                        <option value="premium">premium (user, premium)</option>
                                        <option value="moderator">moderator (user, moderator)</option>
                                    </select>
                                </div>
                                <button className="btn btn-success" onClick={login} disabled={loading}>
                                    Get JWT Token
                                </button>
                                <div className="demo-actions">
                                    <button className="btn" onClick={() => getCustomToken('user')}>Quick: User Token</button>
                                    <button className="btn" onClick={() => getCustomToken('admin')}>Quick: Admin Token</button>
                                    <button className="btn" onClick={() => getCustomToken('premium')}>Quick: Premium Token</button>
                                </div>
                            </div>
                        ) : (
                            <div>
                                <div style={{display: 'flex', alignItems: 'center', marginBottom: '15px'}}>
                                    <span className="status-indicator status-success"></span>
                                    <strong>Authenticated as: {user?.username || 'Loading...'}</strong>
                                </div>
                                {user && (
                                    <div>
                                        <p><strong>Roles:</strong> {user.roles?.join(', ')}</p>
                                        <p><strong>User ID:</strong> {user.user_id}</p>
                                        <p><strong>Email:</strong> {user.email}</p>
                                    </div>
                                )}
                                <div className="demo-actions">
                                    <button className="btn btn-danger" onClick={logout}>Logout</button>
                                    <button className="btn" onClick={getCurrentUser}>Refresh User Info</button>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="demo-grid">
                        {/* Feature Demonstrations */}
                        <div className="card feature-demo">
                            <h3>📋 Package Features</h3>
                            <div className="feature-list">
                                <div className="feature-item">
                                    <h4>🛡️ JWT Authorization</h4>
                                    <p>Role-based access control with custom token decoder</p>
                                </div>
                                <div className="feature-item">
                                    <h4>✅ Validation</h4>
                                    <p>Pydantic schemas with pre/post validators</p>
                                </div>
                                <div className="feature-item">
                                    <h4>🚦 Rate Limiting</h4>
                                    <p>Token bucket with memory/Redis backends</p>
                                </div>
                                <div className="feature-item">
                                    <h4>📝 Structured Logging</h4>
                                    <p>JSON logs with correlation IDs & masking</p>
                                </div>
                            </div>
                        </div>

                        {/* Public Endpoints */}
                        <div className="card">
                            <h3>🌍 Public Endpoints (No Auth Required)</h3>
                            
                            <div className="input-group">
                                <label>Contact Form</label>
                                <input 
                                    placeholder="Name"
                                    value={contactForm.name}
                                    onChange={(e) => setContactForm({...contactForm, name: e.target.value})}
                                />
                                <input 
                                    placeholder="Email"
                                    value={contactForm.email}
                                    onChange={(e) => setContactForm({...contactForm, email: e.target.value})}
                                />
                                <textarea 
                                    placeholder="Message"
                                    value={contactForm.message}
                                    onChange={(e) => setContactForm({...contactForm, message: e.target.value})}
                                />
                            </div>
                            
                            <div className="demo-actions">
                                <button className="btn" onClick={testContactForm} disabled={loading}>
                                    Submit Contact (Rate Limited: 10/min)
                                </button>
                                <button className="btn btn-danger" onClick={testRateLimit} disabled={loading}>
                                    Test Rate Limiting (10 rapid calls)
                                </button>
                            </div>
                        </div>

                        {/* Protected Endpoints */}
                        <div className="card">
                            <h3>🔒 Protected Endpoints (Auth Required)</h3>
                            
                            <div className="input-group">
                                <label>Create Post</label>
                                <input 
                                    placeholder="Title"
                                    value={postForm.title}
                                    onChange={(e) => setPostForm({...postForm, title: e.target.value})}
                                />
                                <textarea 
                                    placeholder="Content"
                                    value={postForm.content}
                                    onChange={(e) => setPostForm({...postForm, content: e.target.value})}
                                />
                                <input 
                                    placeholder="Tags (comma separated)"
                                    value={postForm.tags}
                                    onChange={(e) => setPostForm({...postForm, tags: e.target.value})}
                                />
                            </div>
                            
                            <div className="demo-actions">
                                <button className="btn" onClick={createPost} disabled={loading || !token}>
                                    Create Post (User role + Rate limited: 5/min)
                                </button>
                                <button className="btn btn-danger" onClick={testValidationError} disabled={loading || !token}>
                                    Test Validation Error
                                </button>
                            </div>
                        </div>

                        {/* Admin Endpoints */}
                        <div className="card">
                            <h3>👑 Admin Endpoints</h3>
                            
                            <div className="input-group">
                                <label>Create User (Admin Only)</label>
                                <input 
                                    placeholder="Username"
                                    value={userForm.username}
                                    onChange={(e) => setUserForm({...userForm, username: e.target.value})}
                                />
                                <input 
                                    type="number"
                                    placeholder="Age"
                                    value={userForm.age}
                                    onChange={(e) => setUserForm({...userForm, age: parseInt(e.target.value)})}
                                />
                                <input 
                                    placeholder="Email (must be @company.com)"
                                    value={userForm.email}
                                    onChange={(e) => setUserForm({...userForm, email: e.target.value})}
                                />
                            </div>
                            
                            <div className="demo-actions">
                                <button className="btn" onClick={createUser} disabled={loading || !token}>
                                    Create User (Post-validators + Logging)
                                </button>
                                <button className="btn" onClick={getAdminStats} disabled={loading || !token}>
                                    Get Admin Stats
                                </button>
                            </div>
                        </div>

                        {/* Premium Endpoints */}
                        <div className="card">
                            <h3>💎 Premium Features</h3>
                            <div className="demo-actions">
                                <button className="btn" onClick={getPremiumData} disabled={loading || !token}>
                                    Get Premium Data (Premium/Admin role)
                                </button>
                            </div>
                        </div>

                        {/* Validation Demo */}
                        <div className="card">
                            <h3>🔍 Validation Demo (4-Field Profile)</h3>
                            
                            <div className="input-group">
                                <label>Username (3+ chars, alphanumeric)</label>
                                <input 
                                    placeholder="Username"
                                    value={profileForm.username}
                                    onChange={(e) => setProfileForm({...profileForm, username: e.target.value})}
                                />
                                <label>Email (@company.com required)</label>
                                <input 
                                    placeholder="Email"
                                    value={profileForm.email}
                                    onChange={(e) => setProfileForm({...profileForm, email: e.target.value})}
                                />
                                <label>Age (18-65)</label>
                                <input 
                                    type="number"
                                    placeholder="Age"
                                    value={profileForm.age}
                                    onChange={(e) => setProfileForm({...profileForm, age: parseInt(e.target.value) || 0})}
                                />
                                <label>Department</label>
                                <select 
                                    value={profileForm.department}
                                    onChange={(e) => setProfileForm({...profileForm, department: e.target.value})}
                                >
                                    <option value="Engineering">Engineering</option>
                                    <option value="Marketing">Marketing</option>
                                    <option value="Sales">Sales</option>
                                    <option value="Hr">HR</option>
                                    <option value="Finance">Finance</option>
                                    <option value="InvalidDept">InvalidDept (will fail)</option>
                                </select>
                            </div>
                            
                            <div className="demo-actions">
                                <button className="btn btn-success" onClick={testProfileValidation} disabled={loading}>
                                    Test Valid Profile
                                </button>
                                <button className="btn btn-danger" onClick={testInvalidProfile} disabled={loading}>
                                    Test Multiple Validation Errors
                                </button>
                                <button className="btn" onClick={getProfileExamples} disabled={loading}>
                                    Get Validation Examples
                                </button>
                            </div>
                            
                            <div style={{marginTop: '10px', fontSize: '12px', color: '#666'}}>
                                <strong>Validation Features:</strong> Pre-validators (cleanup), Post-validators (business rules), Structured logging
                            </div>
                        </div>
                    </div>
                    
                    {/* Response Display */}
                    {lastResponse && (
                        <div className="card">
                            <h3>📡 Last API Response</h3>
                            <div style={{display: 'flex', alignItems: 'center', marginBottom: '10px'}}>
                                <span className={`status-indicator ${lastResponse.error ? 'status-error' : 'status-success'}`}></span>
                                <strong>{lastResponse.endpoint}</strong>
                                <span style={{marginLeft: '10px', background: lastResponse.error ? '#FEE2E2' : '#D1FAE5', 
                                            padding: '2px 8px', borderRadius: '4px', fontSize: '12px'}}>
                                    {lastResponse.status}
                                </span>
                            </div>
                            <div className="response-display">
                                {JSON.stringify(lastResponse.data, null, 2)}
                            </div>
                        </div>
                    )}

                    {/* Live Logs */}
                    <div className="card logs-section">
                        <h3 style={{color: '#00ff00', marginBottom: '15px'}}>📊 Live Demo Logs</h3>
                        <div>
                            {logs.map(log => (
                                <div key={log.id} style={{marginBottom: '5px', fontSize: '11px'}}>
                                    <span style={{color: '#888'}}>[{log.timestamp.split('T')[1].split('.')[0]}]</span>
                                    <span style={{color: log.level === 'ERROR' ? '#ff4444' : 
                                                       log.level === 'SUCCESS' ? '#44ff44' : 
                                                       log.level === 'WARNING' ? '#ffaa44' : '#00ff00',
                                                 marginLeft: '5px'}}>
                                        {log.level}
                                    </span>
                                    <span style={{marginLeft: '10px'}}>{log.message}</span>
                                    {Object.keys(log.data).length > 0 && (
                                        <span style={{color: '#888', marginLeft: '10px'}}>
                                            {JSON.stringify(log.data)}
                                        </span>
                                    )}
                                </div>
                            ))}
                            {logs.length === 0 && (
                                <div style={{color: '#888', fontStyle: 'italic'}}>
                                    No logs yet. Try making some API calls!
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<APIGatewayDemo />, document.getElementById('root'));
    </script>
</body>
</html>